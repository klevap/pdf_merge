<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Page Builder</title>
    
    <!-- Libraries -->
    <!-- –í–∞–∂–Ω–æ: ID –Ω—É–∂–Ω—ã –¥–ª—è —Å–∫—Ä–∏–ø—Ç–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –∏ –∑–∞–º–µ–Ω–∏—Ç—å –∏—Ö -->
    <script id="lib-pdflib" src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script id="lib-pdfjs" src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script id="lib-sortable" src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –Ω–∞—à —Å–∫—Ä–∏–ø—Ç-—ç–∫—Å–ø–æ—Ä—Ç–µ—Ä -->
    <script src="bundler.js"></script>

    <style>
        :root {
            --source-card-width: 130px; 
            --target-card-width: 200px; 
            --header-height: 60px;
            --toolbar-height: 50px;
            --primary-color: #007bff;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #f4f7f6;
            overflow: hidden;
        }

        /* Header */
        header {
            height: var(--header-height);
            background: #fff;
            padding: 0 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 20;
            flex-shrink: 0;
        }
        
        .header-actions { display: flex; gap: 10px; align-items: center; }
        
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
            font-weight: 500;
            font-size: 0.9rem;
            white-space: nowrap;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn-primary { background: var(--primary-color); }
        .btn-success { background: #28a745; }
        .btn-dark { background: #343a40; }
        .btn:hover { opacity: 0.9; }
        input[type="file"] { display: none; }

        .size-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .size-selector select {
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 0.9rem;
        }

        /* Toolbar */
        .toolbar {
            height: var(--toolbar-height);
            background: #e9ecef;
            display: flex;
            align-items: center;
            padding: 0 20px;
            border-bottom: 1px solid #ccc;
            gap: 20px;
            flex-shrink: 0;
        }
        .zoom-control { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }

        /* Workspace */
        .workspace {
            display: flex;
            height: calc(100vh - var(--header-height) - var(--toolbar-height));
            overflow: hidden;
        }

        /* Left Panel */
        .sources-panel {
            width: 450px;
            background: #f8f9fa;
            border-right: 1px solid #ccc;
            overflow-y: auto; 
            padding: 15px;
            flex-shrink: 0;
            height: 100%; 
        }

        .source-file {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .source-header {
            padding: 10px;
            background: #f1f1f1;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #eee;
        }
        
        /* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∫–∞—Ä—Ç–∏–Ω–æ–∫ */
        .source-header.images-header {
            background: #e3f2fd;
            color: #0d47a1;
        }

        .page-list {
            padding: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            background: #fff;
        }
        
        .source-file.collapsed .page-list { display: none; }

        /* Right Panel */
        .target-panel {
            flex: 1;
            padding: 20px;
            background: #fff;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: 100%;
        }

        .target-header { margin-bottom: 10px; font-weight: bold; color: #555; }

        #new-doc-area {
            flex: 1;
            border: 2px dashed #ccc;
            background: #fafafa;
            border-radius: 6px;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start;
            gap: 15px;
        }
        #new-doc-area.drag-over { background: #eef6ff; border-color: var(--primary-color); }

        /* Cards */
        .page-card {
            background: white;
            border: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: grab;
            position: relative;
            user-select: none;
            transition: width 0.1s ease;
        }

        .sources-panel .page-card { width: var(--source-card-width); }
        .target-panel .page-card { width: var(--target-card-width); }

        .page-card canvas, .page-card img {
            width: 100%;
            height: auto;
            pointer-events: none;
            display: block;
            object-fit: contain;
            background: #eee; /* —Ñ–æ–Ω –¥–ª—è –ø—Ä–æ–∑—Ä–∞—á–Ω—ã—Ö png */
        }

        .page-number {
            width: 100%;
            text-align: center;
            font-size: 0.8rem;
            padding: 4px;
            background: #fff;
            color: #555;
            border-top: 1px solid #eee;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .remove-btn {
            position: absolute;
            top: -8px; right: -8px;
            width: 24px; height: 24px;
            background: #dc3545; color: white;
            border-radius: 50%;
            text-align: center; line-height: 22px;
            cursor: pointer; font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 10;
            display: none; 
        }
        #new-doc-area .page-card .remove-btn { display: block; }

        .usage-counter {
            position: absolute;
            top: -8px; left: -8px;
            width: 24px; height: 24px;
            background: #28a745; color: white;
            border-radius: 50%;
            text-align: center; line-height: 24px;
            font-size: 12px; font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 10;
            display: none;
        }
        #new-doc-area .page-card .usage-counter { display: none !important; }

        /* Loader */
        .loading-overlay {
            position: fixed;
            top:0; left:0; right:0; bottom:0;
            background: rgba(255,255,255,0.9);
            z-index: 1000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid #f3f3f3; border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="loading-overlay" id="loader">
    <div class="spinner"></div>
    <div style="margin-top:10px" id="loader-text">Processing...</div>
</div>

<header>
    <h1>PDF Page Builder</h1>
    <div class="header-actions">
        <label class="btn btn-primary">
            <span>+ Add PDF / Images</span>
            <!-- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
            <input type="file" id="file-input" multiple accept="application/pdf, image/jpeg, image/png">
        </label>
        
        <div class="size-selector">
            <label for="target-width">Target Width:</label>
            <select id="target-width">
                <option value="none">Original Size</option>
                <option value="1920">Full HD (1920pt)</option>
                <option value="595.28">A4 Portrait (595pt)</option>
                <option value="841.89">A4 Landscape (842pt)</option>
            </select>
        </div>
        
        <button class="btn btn-success" onclick="generatePDF()">Download PDF</button>
        
        <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã -->
        <button class="btn btn-dark" onclick="saveOfflineVersion()" title="Save this tool as a single HTML file">
            Save App Offline
        </button>
    </div>
</header>

<div class="toolbar">
    <div class="zoom-control">
        <label>Source Zoom:</label>
        <input type="range" id="source-zoom" min="80" max="400" value="130">
    </div>
    <div class="zoom-control">
        <label>Target Zoom:</label>
        <input type="range" id="target-zoom" min="100" max="500" value="200">
    </div>
</div>

<div class="workspace">
    <div class="sources-panel" id="sources-container">
        <div style="text-align:center; color:#999; margin-top:20px;" id="empty-msg">
            Upload PDF files or Images to start
        </div>
    </div>

    <div class="target-panel">
        <div class="target-header">New Document</div>
        <div id="new-doc-area"></div>
    </div>
</div>

<script>
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ PDF.js
    // –ï—Å–ª–∏ –º—ã –≤ –æ—Ñ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º–µ (–∫–æ–¥ –∏–Ω–∂–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω), workerSrc –º–æ–∂–µ—Ç –±—ã—Ç—å —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
    if (!pdfjsLib.GlobalWorkerOptions.workerSrc) {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }

    const fileInput = document.getElementById('file-input');
    const sourcesContainer = document.getElementById('sources-container');
    const newDocArea = document.getElementById('new-doc-area');
    const loader = document.getElementById('loader');
    const loaderText = document.getElementById('loader-text');

    // –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö: { 'f1': ArrayBuffer, 'img_123': { buffer: ArrayBuffer, type: 'jpg/png' } }
    const dataStore = {}; 
    let fileCounter = 0;
    let imageCounter = 0;

    // --- –ó—É–º ---
    const sourceZoom = document.getElementById('source-zoom');
    const targetZoom = document.getElementById('target-zoom');
    const root = document.documentElement;

    sourceZoom.addEventListener('input', (e) => root.style.setProperty('--source-card-width', e.target.value + 'px'));
    targetZoom.addEventListener('input', (e) => root.style.setProperty('--target-card-width', e.target.value + 'px'));

    // --- Sortable ---
    new Sortable(newDocArea, {
        group: 'shared',
        animation: 150,
        ghostClass: 'sortable-ghost',
        onAdd: function (evt) {
            evt.item.removeAttribute('id');
            updatePageCounters();
        },
        onSort: function (evt) {
            updatePageCounters();
        }
    });

    newDocArea.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-btn')) {
            e.target.closest('.page-card').remove();
            updatePageCounters();
        }
    });

    // --- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ ---
    fileInput.addEventListener('change', async (e) => {
        const files = Array.from(e.target.files);
        if(!files.length) return;

        const emptyMsg = document.getElementById('empty-msg');
        if(emptyMsg) emptyMsg.style.display = 'none';

        loader.style.display = 'flex';
        loaderText.innerText = 'Processing files...';
        
        for (const file of files) {
            try {
                if (file.type === 'application/pdf') {
                    await processPdf(file);
                } else if (file.type.startsWith('image/')) {
                    await processImage(file);
                }
            } catch (err) {
                console.error(err);
                alert("Error loading " + file.name);
            }
        }
        
        loader.style.display = 'none';
        fileInput.value = '';
    });

    async function processPdf(file) {
        const fileId = `pdf_${fileCounter++}`;
        const buffer = await file.arrayBuffer();
        dataStore[fileId] = { type: 'pdf', buffer: buffer.slice(0) };

        const pdfDoc = await pdfjsLib.getDocument(buffer).promise;

        const fileDiv = document.createElement('div');
        fileDiv.className = 'source-file';
        
        const header = document.createElement('div');
        header.className = 'source-header';
        header.innerHTML = `<span>üìÑ ${file.name}</span><span>‚ñº</span>`;
        header.onclick = () => fileDiv.classList.toggle('collapsed');

        const pageList = document.createElement('div');
        pageList.className = 'page-list';

        fileDiv.append(header, pageList);
        sourcesContainer.append(fileDiv);

        for (let i = 1; i <= pdfDoc.numPages; i++) {
            const page = await pdfDoc.getPage(i);
            const viewport = page.getViewport({ scale: 1.0 }); // Thumbnail scale

            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = viewport.width;
            canvas.height = viewport.height;

            await page.render({ canvasContext: context, viewport: viewport }).promise;

            const card = createCard(canvas, `Page ${i}`, fileId, i);
            pageList.appendChild(card);
        }

        initSortable(pageList);
    }

    async function processImage(file) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–∞—Ä—Ç–∏–Ω–æ–∫
        let imgContainer = document.getElementById('images-container');
        let pageList;

        if (!imgContainer) {
            imgContainer = document.createElement('div');
            imgContainer.className = 'source-file';
            imgContainer.id = 'images-container';
            
            const header = document.createElement('div');
            header.className = 'source-header images-header';
            header.innerHTML = `<span>üñºÔ∏è Imported Images</span><span>‚ñº</span>`;
            header.onclick = () => imgContainer.classList.toggle('collapsed');

            pageList = document.createElement('div');
            pageList.className = 'page-list';
            
            imgContainer.append(header, pageList);
            // –í—Å—Ç–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞
            sourcesContainer.insertBefore(imgContainer, sourcesContainer.firstChild);
            
            initSortable(pageList);
        } else {
            pageList = imgContainer.querySelector('.page-list');
        }

        const imgId = `img_${imageCounter++}`;
        const buffer = await file.arrayBuffer();
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –¥–ª—è pdf-lib
        const isPng = file.type === 'image/png';
        dataStore[imgId] = { 
            type: isPng ? 'png' : 'jpg', 
            buffer: buffer.slice(0),
            name: file.name
        };

        // –°–æ–∑–¥–∞–µ–º –ø—Ä–µ–≤—å—é
        const img = new Image();
        const blob = new Blob([buffer], { type: file.type });
        const url = URL.createObjectURL(blob);
        
        img.onload = () => {
            const card = createCard(img, file.name, imgId, 0); // pid 0 –¥–ª—è –∫–∞—Ä—Ç–∏–Ω–æ–∫
            pageList.appendChild(card);
            // URL.revokeObjectURL(url); // –ù–µ —É–¥–∞–ª—è–µ–º —Å—Ä–∞–∑—É, —á—Ç–æ–±—ã –∫–∞—Ä—Ç–∏–Ω–∫–∞ –æ—Å—Ç–∞–ª–∞—Å—å –≤ DOM
        };
        img.src = url;
    }

    function createCard(visualElement, labelText, fid, pid) {
        const card = document.createElement('div');
        card.className = 'page-card';
        card.dataset.fid = fid;
        card.dataset.pid = pid;

        card.innerHTML = `
            <div class="remove-btn">√ó</div>
            <div class="usage-counter">0</div>
            <div class="page-number">${labelText}</div>
        `;
        card.insertBefore(visualElement, card.querySelector('.page-number'));
        return card;
    }

    function initSortable(element) {
        new Sortable(element, {
            group: { name: 'shared', pull: 'clone', put: false },
            sort: false,
            animation: 150,
            onClone: function(evt) {
                // –ö–ª–æ–Ω–∏—Ä—É–µ–º Canvas –∏–ª–∏ Image –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
                const origVisual = evt.item.querySelector('canvas, img');
                const cloneVisual = evt.clone.querySelector('canvas, img');
                
                if (origVisual.tagName === 'CANVAS') {
                    cloneVisual.width = origVisual.width;
                    cloneVisual.height = origVisual.height;
                    cloneVisual.getContext('2d').drawImage(origVisual, 0, 0);
                }
                // –î–ª—è IMG src –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
            }
        });
    }

    function updatePageCounters() {
        const targetCards = newDocArea.querySelectorAll('.page-card');
        const counts = {}; 
        targetCards.forEach(card => {
            const key = `${card.dataset.fid}-${card.dataset.pid}`;
            counts[key] = (counts[key] || 0) + 1;
        });

        const sourceCards = document.querySelectorAll('.sources-panel .page-card');
        sourceCards.forEach(card => {
            const key = `${card.dataset.fid}-${card.dataset.pid}`;
            const count = counts[key] || 0;
            const badge = card.querySelector('.usage-counter');
            if (badge) {
                badge.innerText = count;
                badge.style.display = count > 0 ? 'block' : 'none';
            }
            card.style.borderColor = count > 0 ? '#28a745' : '#ddd';
        });
    }

    // --- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF ---
    async function generatePDF() {
        const cards = newDocArea.querySelectorAll('.page-card');
        if (!cards.length) {
            alert("New document is empty!");
            return;
        }

        const selectedWidth = document.getElementById('target-width').value;
        const shouldScale = selectedWidth !== 'none';
        const targetWidthVal = parseFloat(selectedWidth);

        loader.style.display = 'flex';
        loaderText.innerText = 'Generating PDF...';

        try {
            const { PDFDocument } = PDFLib;
            const newPdf = await PDFDocument.create();
            const loadedPdfDocs = {}; // –ö—ç—à –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö PDF –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

            for (const card of cards) {
                const fid = card.dataset.fid;
                const dataItem = dataStore[fid];

                if (dataItem.type === 'pdf') {
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ PDF —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                    const pid = parseInt(card.dataset.pid);
                    
                    if (!loadedPdfDocs[fid]) {
                        loadedPdfDocs[fid] = await PDFDocument.load(dataItem.buffer);
                    }
                    const srcDoc = loadedPdfDocs[fid];
                    const [copiedPage] = await newPdf.copyPages(srcDoc, [pid - 1]);

                    if (shouldScale) {
                        const { width, height } = copiedPage.getSize();
                        const scaleFactor = targetWidthVal / width;
                        copiedPage.scaleContent(scaleFactor, scaleFactor);
                        copiedPage.setSize(targetWidthVal, height * scaleFactor);
                    }
                    newPdf.addPage(copiedPage);

                } else {
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    let image;
                    if (dataItem.type === 'jpg') {
                        image = await newPdf.embedJpg(dataItem.buffer);
                    } else {
                        image = await newPdf.embedPng(dataItem.buffer);
                    }

                    let dims = image.scale(1);
                    
                    // –õ–æ–≥–∏–∫–∞ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –∫–∞—Ä—Ç–∏–Ω–∫–∏
                    if (shouldScale) {
                        const scaleFactor = targetWidthVal / dims.width;
                        dims = {
                            width: targetWidthVal,
                            height: dims.height * scaleFactor
                        };
                    }

                    const page = newPdf.addPage([dims.width, dims.height]);
                    page.drawImage(image, {
                        x: 0,
                        y: 0,
                        width: dims.width,
                        height: dims.height,
                    });
                }
            }

            const pdfBytes = await newPdf.save();
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'merged_document.pdf';
            link.click();
        } catch (e) {
            console.error(e);
            alert("Error creating PDF: " + e.message);
        } finally {
            loader.style.display = 'none';
        }
    }
</script>

</body>
</html>