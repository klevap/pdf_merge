<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Builder Tool</title>
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        :root {
            --source-card-width: 150px;
            --target-card-width: 150px;
            --bg-color: #f4f7f6;
            --primary-color: #007bff;
            --header-height: 60px;
            --toolbar-height: 50px;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: var(--bg-color);
            color: #333;
            overflow: hidden; /* Prevent body scroll */
        }

        /* Header */
        header {
            height: var(--header-height);
            background-color: #fff;
            padding: 0 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 20;
            flex-shrink: 0;
        }

        h1 { margin: 0; font-size: 1.4rem; color: #2c3e50; }

        .header-actions { display: flex; gap: 10px; }

        button, .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
            font-weight: 500;
        }

        .btn-primary { background-color: var(--primary-color); color: white; display: inline-flex; align-items: center; }
        .btn-primary:hover { background-color: #0056b3; }
        
        .btn-success { background-color: #28a745; color: white; }
        .btn-success:hover { background-color: #218838; }

        input[type="file"] { display: none; }

        /* Toolbar for Zoom */
        .toolbar {
            height: var(--toolbar-height);
            background-color: #e9ecef;
            display: flex;
            align-items: center;
            padding: 0 20px;
            border-bottom: 1px solid #ddd;
            gap: 30px;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .zoom-control { display: flex; align-items: center; gap: 10px; }
        input[type=range] { cursor: pointer; }

        /* Workspace */
        .workspace {
            display: flex;
            /* Calculate exact remaining height */
            height: calc(100vh - var(--header-height) - var(--toolbar-height));
            overflow: hidden;
        }

        /* Left Panel (Sources) */
        .sources-panel {
            width: 420px;
            background-color: #f8f9fa;
            border-right: 1px solid #ccc;
            padding: 15px;
            flex-shrink: 0;
            
            /* Scrolling Fixes */
            overflow-y: auto; 
            height: 100%;
            display: block; /* Ensure block layout for scrolling */
        }

        .source-file {
            background: #fff;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 15px; /* Spacing between files */
        }

        .source-header {
            padding: 10px 15px;
            background: #fff;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .source-header:hover { background-color: #f1f1f1; }
        
        .source-title { font-weight: 600; font-size: 0.95rem; word-break: break-all; }
        .toggle-icon { transition: transform 0.2s; font-size: 0.8rem; color: #777; }
        .source-file.collapsed .toggle-icon { transform: rotate(-90deg); }
        .source-file.collapsed .page-list { display: none; }

        .page-list {
            padding: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            background-color: #fafafa;
            justify-content: center; /* Center cards if they are wide */
        }

        /* Right Panel (Target) */
        .target-panel {
            flex: 1;
            padding: 20px;
            background-color: #fff;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden; /* Internal scroll handles content */
        }

        .target-header { margin-bottom: 10px; color: #555; font-size: 1.1rem; flex-shrink: 0; }

        #new-doc-area {
            flex: 1;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            padding: 20px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            align-content: flex-start;
            background-color: #fdfdfd;
            overflow-y: auto; /* Scroll inside the drop area */
        }

        #new-doc-area.drag-over { background-color: #eef6ff; border-color: var(--primary-color); }

        /* Page Card Styles */
        .page-card {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: grab;
            position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* Dynamic Widths based on sliders */
        .sources-panel .page-card { width: var(--source-card-width); }
        .target-panel .page-card { width: var(--target-card-width); }

        .page-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            transform: translateY(-2px);
            z-index: 5;
        }

        .page-card canvas {
            width: 100%;
            height: auto;
            display: block;
            border-bottom: 1px solid #eee;
            pointer-events: none;
        }

        .page-number {
            font-size: 0.8rem;
            padding: 5px;
            color: #666;
            text-align: center;
            width: 100%;
            background: #fff;
        }

        .remove-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            text-align: center;
            line-height: 22px;
            font-size: 16px;
            cursor: pointer;
            display: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 10;
            font-weight: bold;
        }

        /* Show remove button only in target area */
        #new-doc-area .page-card .remove-btn { display: block; }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            display: none;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .empty-msg { width: 100%; text-align: center; color: #999; margin-top: 40px; }
    </style>
</head>
<body>

<div class="loading-overlay" id="loader">
    <div class="spinner"></div>
    <div id="loader-text">Processing...</div>
</div>

<header>
    <h1>PDF Builder</h1>
    <div class="header-actions">
        <label class="btn btn-primary">
            <span>+ Add PDF Files</span>
            <input type="file" id="file-input" multiple accept="application/pdf">
        </label>
        <button class="btn btn-success" onclick="generatePDF()">Save New PDF</button>
    </div>
</header>

<div class="toolbar">
    <div class="zoom-control">
        <label>Source Zoom:</label>
        <!-- Max increased to 500 -->
        <input type="range" id="source-zoom" min="80" max="500" value="150">
    </div>
    <div class="zoom-control">
        <label>Target Zoom:</label>
        <!-- Max increased to 500 -->
        <input type="range" id="target-zoom" min="80" max="500" value="150">
    </div>
</div>

<div class="workspace">
    <!-- Left Panel: Sources -->
    <div class="sources-panel" id="sources-container">
        <div class="empty-msg">Upload PDF files to see pages here.</div>
    </div>

    <!-- Right Panel: Target -->
    <div class="target-panel">
        <div class="target-header">New Document (Drag pages here)</div>
        <div id="new-doc-area">
            <!-- Pages will be dropped here -->
        </div>
    </div>
</div>

<script>
    // Configure PDF.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    const fileInput = document.getElementById('file-input');
    const sourcesContainer = document.getElementById('sources-container');
    const newDocArea = document.getElementById('new-doc-area');
    const loader = document.getElementById('loader');
    const loaderText = document.getElementById('loader-text');

    // Zoom Controls
    const sourceZoom = document.getElementById('source-zoom');
    const targetZoom = document.getElementById('target-zoom');
    const root = document.documentElement;

    sourceZoom.addEventListener('input', (e) => {
        root.style.setProperty('--source-card-width', `${e.target.value}px`);
    });

    targetZoom.addEventListener('input', (e) => {
        root.style.setProperty('--target-card-width', `${e.target.value}px`);
    });

    // Data Store
    const pdfDataStore = {}; // Stores ArrayBuffers
    let fileCounter = 0;

    // Initialize Sortable for the target area
    new Sortable(newDocArea, {
        group: 'shared',
        animation: 150,
        ghostClass: 'sortable-ghost'
    });

    fileInput.addEventListener('change', async (e) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;

        // Clear empty message
        if (sourcesContainer.querySelector('.empty-msg')) {
            sourcesContainer.innerHTML = '';
        }

        loader.style.display = 'flex';
        loaderText.innerText = "Loading files...";

        for (const file of files) {
            try {
                await processUploadedFile(file);
            } catch (err) {
                console.error("Error processing file:", err);
                alert(`Failed to load ${file.name}`);
            }
        }

        loader.style.display = 'none';
        fileInput.value = ''; 
    });

    async function processUploadedFile(file) {
        const fileId = `file_${fileCounter++}`;
        
        // 1. Read file as ArrayBuffer
        const originalBuffer = await file.arrayBuffer();
        
        // 2. Clone buffer for safe keeping
        pdfDataStore[fileId] = originalBuffer.slice(0);

        // 3. Load PDF for rendering
        const pdfDoc = await pdfjsLib.getDocument(originalBuffer).promise;

        // Create UI Container for File
        const fileDiv = document.createElement('div');
        fileDiv.className = 'source-file';
        
        // Header with collapse logic
        const headerDiv = document.createElement('div');
        headerDiv.className = 'source-header';
        headerDiv.innerHTML = `
            <span class="source-title">${file.name} (${pdfDoc.numPages} pages)</span>
            <span class="toggle-icon">â–¼</span>
        `;
        headerDiv.onclick = () => {
            fileDiv.classList.toggle('collapsed');
        };

        const pageListDiv = document.createElement('div');
        pageListDiv.className = 'page-list';
        pageListDiv.id = `list-${fileId}`;

        fileDiv.appendChild(headerDiv);
        fileDiv.appendChild(pageListDiv);
        sourcesContainer.appendChild(fileDiv);

        // Render Pages
        // Increased scale to 0.6 to support larger zoom (up to 500px width) better
        const renderScale = 0.6; 

        for (let i = 1; i <= pdfDoc.numPages; i++) {
            const page = await pdfDoc.getPage(i);
            const viewport = page.getViewport({ scale: renderScale });

            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            await page.render({ canvasContext: context, viewport: viewport }).promise;

            // Create Card
            const card = document.createElement('div');
            card.className = 'page-card';
            card.dataset.fileId = fileId;
            card.dataset.pageIndex = i - 1; // 0-based index for pdf-lib

            // Remove Button
            const removeBtn = document.createElement('div');
            removeBtn.className = 'remove-btn';
            removeBtn.innerHTML = '&times;';
            removeBtn.onclick = function() { card.remove(); };

            const pageNum = document.createElement('div');
            pageNum.className = 'page-number';
            pageNum.innerText = `Page ${i}`;

            card.appendChild(removeBtn);
            card.appendChild(canvas);
            card.appendChild(pageNum);
            pageListDiv.appendChild(card);
        }

        // Make list draggable
        new Sortable(pageListDiv, {
            group: {
                name: 'shared',
                pull: 'clone', 
                put: false 
            },
            sort: false,
            animation: 150
        });
    }

    async function generatePDF() {
        const cards = newDocArea.querySelectorAll('.page-card');
        if (cards.length === 0) {
            alert("Please drag some pages into the New Document area first.");
            return;
        }

        loader.style.display = 'flex';
        loaderText.innerText = "Generating PDF...";

        try {
            const { PDFDocument } = PDFLib;
            const newPdf = await PDFDocument.create();
            const loadedPdfDocs = {};

            for (const card of cards) {
                const fileId = card.dataset.fileId;
                const pageIndex = parseInt(card.dataset.pageIndex);

                if (!loadedPdfDocs[fileId]) {
                    // Pass a COPY (slice) of the buffer to load()
                    const bufferCopy = pdfDataStore[fileId].slice(0);
                    loadedPdfDocs[fileId] = await PDFDocument.load(bufferCopy);
                }

                const sourcePdf = loadedPdfDocs[fileId];
                const [copiedPage] = await newPdf.copyPages(sourcePdf, [pageIndex]);
                newPdf.addPage(copiedPage);
            }

            const pdfBytes = await newPdf.save();
            
            // Download
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'merged_document.pdf';
            link.click();

        } catch (err) {
            console.error(err);
            alert("Error generating PDF. Check console for details.");
        } finally {
            loader.style.display = 'none';
        }
    }
</script>

</body>
</html>