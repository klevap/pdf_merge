<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO Meta Tags -->
    <title>Free PDF Page Builder - Secure, Client-Side, Offline Tool</title>
    <meta name="description" content="Free and secure online PDF Merger and Page Builder. Combine PDF files, reorder pages, rotate pages and convert images to PDF entirely in your browser. No file uploads - 100% private and offline capable.">
    <meta name="keywords" content="merge pdf, pdf builder, client-side pdf, offline pdf tool, combine pdf pages, rotate pdf, free pdf merger, privacy focused pdf, jpg to pdf, secure pdf tool">
    <meta name="author" content="klevap">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Free PDF Page Builder - Secure & Offline">
    <meta property="og:description" content="Merge, rotate and organize PDF pages entirely in your browser. No server uploads. 100% Private.">

    <!-- Schema.org Markup -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "Free PDF Page Builder",
      "applicationCategory": "UtilitiesApplication",
      "operatingSystem": "Any",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "featureList": "Merge PDF, Rotate PDF Pages, Image to PDF, Offline Capable, Client-Side Secure, Drag and Drop Reordering",
      "softwareRequirements": "Modern Web Browser (Chrome, Firefox, Edge, Safari)",
      "author": {
          "@type": "Person",
          "name": "klevap"
      }
    }
    </script>

    <!-- Libraries -->
    <script id="lib-pdflib" src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script id="lib-pdfjs" src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script id="lib-sortable" src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–∫—Ä–∏–ø—Ç-—ç–∫—Å–ø–æ—Ä—Ç–µ—Ä -->
    <script src="bundler.js"></script>

    <style>
        :root {
            --source-card-width: 130px; 
            --target-card-width: 200px; 
            --header-height: 60px;
            --toolbar-height: 50px;
            --footer-height: 40px;
            --primary-color: #007bff;
            --text-color: #333;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #f4f7f6;
            color: var(--text-color);
            overflow: hidden;
        }

        /* Header */
        header {
            height: var(--header-height);
            background: #fff;
            padding: 0 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 20;
            flex-shrink: 0;
        }
        
        h1 { font-size: 1.2rem; margin: 0; display: flex; align-items: center; gap: 10px; }
        .badge-secure {
            background: #e8f5e9; color: #2e7d32;
            font-size: 0.7rem; padding: 2px 8px; border-radius: 12px;
            border: 1px solid #c8e6c9; font-weight: normal;
        }
        
        .header-actions { display: flex; gap: 10px; align-items: center; }
        
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
            font-weight: 500;
            font-size: 0.9rem;
            white-space: nowrap;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s;
        }
        .btn-primary { background: var(--primary-color); }
        .btn-success { background: #28a745; }
        .btn-dark { background: #343a40; }
        .btn-info { background: #17a2b8; }
        .btn:hover { opacity: 0.9; }
        input[type="file"] { display: none; }

        .size-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .size-selector select {
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 0.9rem;
        }

        /* Toolbar */
        .toolbar {
            height: var(--toolbar-height);
            background: #e9ecef;
            display: flex;
            align-items: center;
            padding: 0 20px;
            border-bottom: 1px solid #ccc;
            gap: 20px;
            flex-shrink: 0;
        }
        .zoom-control { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }

        /* Workspace */
        .workspace {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        /* Left Panel */
        .sources-panel {
            width: 450px;
            background: #f8f9fa;
            border-right: 1px solid #ccc;
            overflow-y: auto; 
            padding: 15px;
            flex-shrink: 0;
            height: 100%; 
        }

        .source-file {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .source-header {
            padding: 10px;
            background: #f1f1f1;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #eee;
        }
        .source-header.images-header { background: #e3f2fd; color: #0d47a1; }

        .page-list {
            padding: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            background: #fff;
        }
        .source-file.collapsed .page-list { display: none; }

        /* Right Panel */
        .target-panel {
            flex: 1;
            padding: 20px;
            background: #fff;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: 100%;
        }

        .target-header { margin-bottom: 10px; font-weight: bold; color: #555; }

        #new-doc-area {
            flex: 1;
            border: 2px dashed #ccc;
            background: #fafafa;
            border-radius: 6px;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start;
            gap: 15px;
        }
        #new-doc-area.drag-over { background: #eef6ff; border-color: var(--primary-color); }

        /* Cards */
        .page-card {
            background: white;
            border: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: grab;
            position: relative;
            user-select: none;
            transition: width 0.1s ease;
        }

        .sources-panel .page-card { width: var(--source-card-width); }
        .target-panel .page-card { width: var(--target-card-width); }

        .page-card canvas {
            width: 100%;
            height: auto;
            pointer-events: none;
            display: block;
            object-fit: contain;
            background: #eee;
        }

        .page-number {
            width: 100%;
            text-align: center;
            font-size: 0.8rem;
            padding: 4px;
            background: #fff;
            color: #555;
            border-top: 1px solid #eee;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            z-index: 5;
            position: relative;
        }

        /* –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è */
        .remove-btn {
            position: absolute;
            top: -8px; right: -8px;
            width: 24px; height: 24px;
            background: #dc3545; color: white;
            border-radius: 50%;
            text-align: center; line-height: 22px;
            cursor: pointer; font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 10;
            display: none; 
        }
        #new-doc-area .page-card .remove-btn { display: block; }

        /* –ö–Ω–æ–ø–∫–∞ –ø–æ–≤–æ—Ä–æ—Ç–∞ */
        .rotate-btn {
            position: absolute;
            bottom: 28px;
            right: 5px;
            width: 26px; height: 26px;
            background: #007bff; color: white;
            border-radius: 50%;
            text-align: center; line-height: 26px;
            cursor: pointer; font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 10;
            font-size: 16px;
            display: none;
        }
        .rotate-btn:hover { background: #0056b3; }
        #new-doc-area .page-card .rotate-btn { display: block; }

        .usage-counter {
            position: absolute;
            top: -8px; left: -8px;
            width: 24px; height: 24px;
            background: #28a745; color: white;
            border-radius: 50%;
            text-align: center; line-height: 24px;
            font-size: 12px; font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 10;
            display: none;
        }
        #new-doc-area .page-card .usage-counter { display: none !important; }

        /* Footer for SEO */
        footer {
            background: #343a40;
            color: #adb5bd;
            font-size: 0.8rem;
            text-align: center;
            padding: 10px;
            flex-shrink: 0;
            z-index: 30;
        }
        footer a { color: #fff; text-decoration: none; }
        footer a:hover { text-decoration: underline; }

        /* Loader */
        .loading-overlay {
            position: fixed;
            top:0; left:0; right:0; bottom:0;
            background: rgba(255,255,255,0.9);
            z-index: 1000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid #f3f3f3; border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-close {
            position: absolute;
            top: 15px; right: 15px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            line-height: 1;
        }
        .modal-content h2 { margin-top: 0; color: var(--primary-color); }
        .modal-content h3 { margin-bottom: 10px; color: #333; }
        .modal-content ul { line-height: 1.6; }
        .security-highlight {
            background: #e8f5e9;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 20px 0;
            color: #1b5e20;
        }
    </style>
</head>
<body>

<!-- Loader -->
<div class="loading-overlay" id="loader">
    <div class="spinner"></div>
    <div style="margin-top:10px" id="loader-text">Processing...</div>
</div>

<!-- About Modal -->
<div class="modal-overlay" id="about-modal" onclick="closeAbout(event)">
    <div class="modal-content">
        <span class="modal-close" onclick="toggleAbout()">√ó</span>
        <h2>About PDF Page Builder</h2>
        
        <div class="security-highlight">
            <h3>üîí 100% Secure & Private</h3>
            <p>This tool works entirely in your browser (Client-Side). <strong>Your files are NEVER uploaded to any server.</strong> They stay on your device at all times.</p>
        </div>

        <h3>Why use this tool?</h3>
        <ul>
            <li><strong>Merge PDFs:</strong> Combine multiple documents into one.</li>
            <li><strong>Images to PDF:</strong> Convert JPG and PNG images to PDF pages.</li>
            <li><strong>Rotate Pages:</strong> Easily rotate pages 90, 180, or 270 degrees.</li>
            <li><strong>Organize:</strong> Drag and drop pages to reorder them.</li>
            <li><strong>Offline Capable:</strong> Save this app as an HTML file and use it without internet.</li>
            <li><strong>Free & Open Source:</strong> No hidden costs, no watermarks.</li>
        </ul>

        <p style="font-size: 0.9rem; color: #666; margin-top: 20px;">
            Built with <a href="https://github.com/Hopding/pdf-lib" target="_blank">pdf-lib</a> and <a href="https://mozilla.github.io/pdf.js/" target="_blank">pdf.js</a>.
            <br>
            Source code available on <a href="https://github.com/klevap/pdf_merge" target="_blank">GitHub</a>.
        </p>
        <div style="text-align: right; margin-top: 20px;">
            <button class="btn btn-primary" onclick="toggleAbout()">Got it!</button>
        </div>
    </div>
</div>

<header>
    <h1>
        PDF Page Builder 
        <span class="badge-secure">üîí Secure & Client-Side</span>
    </h1>
    <div class="header-actions">
        <button class="btn btn-info" onclick="toggleAbout()">‚ÑπÔ∏è About & Security</button>
        
        <label class="btn btn-primary">
            <span>+ Add PDF / Images</span>
            <input type="file" id="file-input" multiple accept="application/pdf, image/jpeg, image/png">
        </label>
        
        <div class="size-selector">
            <label for="target-width">Target Width:</label>
            <select id="target-width">
                <option value="none">Original Size</option>
                <option value="1920">Full HD (1920pt)</option>
                <option value="595.28">A4 Portrait (595pt)</option>
                <option value="841.89">A4 Landscape (842pt)</option>
            </select>
        </div>
        
        <button class="btn btn-success" onclick="generatePDF()">Download PDF</button>
        
        <button class="btn btn-dark" onclick="saveOfflineVersion()" title="Save this tool as a single HTML file">
            Save App Offline
        </button>
    </div>
</header>

<div class="toolbar">
    <div class="zoom-control">
        <label>Source Zoom:</label>
        <input type="range" id="source-zoom" min="80" max="400" value="130">
    </div>
    <div class="zoom-control">
        <label>Target Zoom:</label>
        <input type="range" id="target-zoom" min="100" max="500" value="200">
    </div>
</div>

<div class="workspace">
    <div class="sources-panel" id="sources-container">
        <div style="text-align:center; color:#999; margin-top:20px;" id="empty-msg">
            <p style="font-size: 1.2rem; margin-bottom: 10px;">üëã Welcome!</p>
            Upload PDF files or Images to start.<br>
            <small>Your files will not be uploaded to any server.</small>
        </div>
    </div>

    <div class="target-panel">
        <div class="target-header">New Document</div>
        <div id="new-doc-area"></div>
    </div>
</div>

<!-- Footer for SEO -->
<footer>
    Free PDF Page Builder | 100% Client-Side & Secure | Works Offline | <a href="https://github.com/klevap/pdf_merge" target="_blank">Open Source on GitHub</a>
</footer>

<script>
    // --- Modal Logic ---
    function toggleAbout() {
        const modal = document.getElementById('about-modal');
        modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
    }

    function closeAbout(e) {
        if (e.target.id === 'about-modal') {
            toggleAbout();
        }
    }

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ PDF.js
    if (!pdfjsLib.GlobalWorkerOptions.workerSrc) {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }

    const fileInput = document.getElementById('file-input');
    const sourcesContainer = document.getElementById('sources-container');
    const newDocArea = document.getElementById('new-doc-area');
    const loader = document.getElementById('loader');
    const loaderText = document.getElementById('loader-text');

    const dataStore = {}; 
    // –ö—ç—à–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –ø—Ä–∏ –ø–æ–≤–æ—Ä–æ—Ç–µ
    const pdfDocCache = {}; 
    const imageCache = {}; 

    let fileCounter = 0;
    let imageCounter = 0;

    // --- –ó—É–º ---
    const sourceZoom = document.getElementById('source-zoom');
    const targetZoom = document.getElementById('target-zoom');
    const root = document.documentElement;

    sourceZoom.addEventListener('input', (e) => root.style.setProperty('--source-card-width', e.target.value + 'px'));
    targetZoom.addEventListener('input', (e) => root.style.setProperty('--target-card-width', e.target.value + 'px'));

    // --- Sortable ---
    new Sortable(newDocArea, {
        group: 'shared',
        animation: 150,
        ghostClass: 'sortable-ghost',
        onAdd: function (evt) {
            evt.item.removeAttribute('id');
            if (!evt.item.dataset.rotation) {
                evt.item.dataset.rotation = "0";
            }
            updatePageCounters();
        },
        onSort: function (evt) {
            updatePageCounters();
        }
    });

    // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤ –≤ —Ä–∞–±–æ—á–µ–π –æ–±–ª–∞—Å—Ç–∏ (–£–¥–∞–ª–µ–Ω–∏–µ –∏ –ü–æ–≤–æ—Ä–æ—Ç) ---
    newDocArea.addEventListener('click', function(e) {
        const card = e.target.closest('.page-card');
        if (!card) return;

        // –£–¥–∞–ª–µ–Ω–∏–µ
        if (e.target.classList.contains('remove-btn')) {
            card.remove();
            updatePageCounters();
        }

        // –ü–æ–≤–æ—Ä–æ—Ç
        if (e.target.classList.contains('rotate-btn')) {
            let currentRotation = parseInt(card.dataset.rotation || 0);
            currentRotation = (currentRotation + 90) % 360; 
            card.dataset.rotation = currentRotation;
            
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É —Å —É—á–µ—Ç–æ–º –Ω–æ–≤–æ–≥–æ –ø–æ–≤–æ—Ä–æ—Ç–∞
            updateCardVisual(card);
        }
    });

    // --- –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ (–¥–ª—è –ø—Ä–µ–≤—å—é) ---
    async function updateCardVisual(card) {
        const fid = card.dataset.fid;
        const pid = parseInt(card.dataset.pid);
        const rotation = parseInt(card.dataset.rotation || 0);
        const dataItem = dataStore[fid];
        const canvas = card.querySelector('canvas');
        const context = canvas.getContext('2d');

        if (dataItem.type === 'pdf') {
            const pdfDoc = pdfDocCache[fid];
            if (pdfDoc) {
                const page = await pdfDoc.getPage(pid);
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º viewport —Å —É—á–µ—Ç–æ–º –ø–æ–≤–æ—Ä–æ—Ç–∞
                const viewport = page.getViewport({ scale: 1.0, rotation: rotation });
                
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                
                // –†–µ–Ω–¥–µ—Ä–∏–º –∑–∞–Ω–æ–≤–æ
                await page.render({ canvasContext: context, viewport: viewport }).promise;
            }
        } else {
            // –î–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            const img = imageCache[fid];
            if (img) {
                const isRotated = rotation === 90 || rotation === 270;
                // –ï—Å–ª–∏ 90/270, –º–µ–Ω—è–µ–º –º–µ—Å—Ç–∞–º–∏ —à–∏—Ä–∏–Ω—É –∏ –≤—ã—Å–æ—Ç—É canvas
                canvas.width = isRotated ? img.height : img.width;
                canvas.height = isRotated ? img.width : img.height;

                // –û—á–∏—â–∞–µ–º –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
                context.clearRect(0, 0, canvas.width, canvas.height);
                context.save();

                // –°–º–µ—â–∞–µ–º —Ü–µ–Ω—Ç—Ä –∏ –≤—Ä–∞—â–∞–µ–º
                context.translate(canvas.width / 2, canvas.height / 2);
                context.rotate(rotation * Math.PI / 180);
                
                // –†–∏—Å—É–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É (—Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ)
                context.drawImage(img, -img.width / 2, -img.height / 2);
                context.restore();
            }
        }
    }

    // --- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ ---
    fileInput.addEventListener('change', async (e) => {
        const files = Array.from(e.target.files);
        if(!files.length) return;

        const emptyMsg = document.getElementById('empty-msg');
        if(emptyMsg) emptyMsg.style.display = 'none';

        loader.style.display = 'flex';
        loaderText.innerText = 'Processing files...';
        
        for (const file of files) {
            try {
                if (file.type === 'application/pdf') {
                    await processPdf(file);
                } else if (file.type.startsWith('image/')) {
                    await processImage(file);
                }
            } catch (err) {
                console.error(err);
                alert("Error loading " + file.name);
            }
        }
        
        loader.style.display = 'none';
        fileInput.value = '';
    });

    async function processPdf(file) {
        const fileId = `pdf_${fileCounter++}`;
        const buffer = await file.arrayBuffer();
        dataStore[fileId] = { type: 'pdf', buffer: buffer.slice(0) };

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç –≤ –∫—ç—à –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –ø—Ä–∏ –ø–æ–≤–æ—Ä–æ—Ç–µ
        const pdfDoc = await pdfjsLib.getDocument(buffer).promise;
        pdfDocCache[fileId] = pdfDoc;

        const fileDiv = document.createElement('div');
        fileDiv.className = 'source-file';
        
        const header = document.createElement('div');
        header.className = 'source-header';
        header.innerHTML = `<span>üìÑ ${file.name}</span><span>‚ñº</span>`;
        header.onclick = () => fileDiv.classList.toggle('collapsed');

        const pageList = document.createElement('div');
        pageList.className = 'page-list';

        fileDiv.append(header, pageList);
        sourcesContainer.append(fileDiv);

        for (let i = 1; i <= pdfDoc.numPages; i++) {
            const page = await pdfDoc.getPage(i);
            const viewport = page.getViewport({ scale: 1.0 });

            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = viewport.width;
            canvas.height = viewport.height;

            await page.render({ canvasContext: context, viewport: viewport }).promise;

            const card = createCard(canvas, `Page ${i}`, fileId, i);
            pageList.appendChild(card);
        }

        initSortable(pageList);
    }

    async function processImage(file) {
        let imgContainer = document.getElementById('images-container');
        let pageList;

        if (!imgContainer) {
            imgContainer = document.createElement('div');
            imgContainer.className = 'source-file';
            imgContainer.id = 'images-container';
            
            const header = document.createElement('div');
            header.className = 'source-header images-header';
            header.innerHTML = `<span>üñºÔ∏è Imported Images</span><span>‚ñº</span>`;
            header.onclick = () => imgContainer.classList.toggle('collapsed');

            pageList = document.createElement('div');
            pageList.className = 'page-list';
            
            imgContainer.append(header, pageList);
            sourcesContainer.insertBefore(imgContainer, sourcesContainer.firstChild);
            
            initSortable(pageList);
        } else {
            pageList = imgContainer.querySelector('.page-list');
        }

        const imgId = `img_${imageCounter++}`;
        const buffer = await file.arrayBuffer();
        const isPng = file.type === 'image/png';
        dataStore[imgId] = { 
            type: isPng ? 'png' : 'jpg', 
            buffer: buffer.slice(0),
            name: file.name
        };

        const img = new Image();
        const blob = new Blob([buffer], { type: file.type });
        const url = URL.createObjectURL(blob);
        
        img.onload = () => {
            // –ö—ç—à–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç Image –¥–ª—è –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
            imageCache[imgId] = img;

            // –°–æ–∑–¥–∞–µ–º canvas –≤–º–µ—Å—Ç–æ img —Ç–µ–≥–∞, —á—Ç–æ–±—ã —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É –ø–æ–≤–æ—Ä–æ—Ç–∞
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);

            const card = createCard(canvas, file.name, imgId, 0);
            pageList.appendChild(card);
        };
        img.src = url;
    }

    function createCard(visualElement, labelText, fid, pid) {
        const card = document.createElement('div');
        card.className = 'page-card';
        card.dataset.fid = fid;
        card.dataset.pid = pid;
        card.dataset.rotation = "0"; 

        card.innerHTML = `
            <div class="remove-btn" title="Remove">√ó</div>
            <div class="rotate-btn" title="Rotate 90¬∞">‚Üª</div>
            <div class="usage-counter">0</div>
            <div class="page-number">${labelText}</div>
        `;
        card.insertBefore(visualElement, card.querySelector('.remove-btn'));
        return card;
    }

    function initSortable(element) {
        new Sortable(element, {
            group: { name: 'shared', pull: 'clone', put: false },
            sort: false,
            animation: 150,
            onClone: function(evt) {
                const origCanvas = evt.item.querySelector('canvas');
                const cloneCanvas = evt.clone.querySelector('canvas');
                
                // –ü—Ä–∏ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ canvas –Ω—É–∂–Ω–æ –≤—Ä—É—á–Ω—É—é —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
                if (origCanvas && cloneCanvas) {
                    cloneCanvas.width = origCanvas.width;
                    cloneCanvas.height = origCanvas.height;
                    cloneCanvas.getContext('2d').drawImage(origCanvas, 0, 0);
                }
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–≤–æ—Ä–æ—Ç —É –∫–ª–æ–Ω–∞ –≤ –∏—Å—Ç–æ—á–Ω–∏–∫–µ (–≤–∏–∑—É–∞–ª—å–Ω–æ)
                evt.clone.dataset.rotation = "0";
            }
        });
    }

    function updatePageCounters() {
        const targetCards = newDocArea.querySelectorAll('.page-card');
        const counts = {}; 
        targetCards.forEach(card => {
            const key = `${card.dataset.fid}-${card.dataset.pid}`;
            counts[key] = (counts[key] || 0) + 1;
        });

        const sourceCards = document.querySelectorAll('.sources-panel .page-card');
        sourceCards.forEach(card => {
            const key = `${card.dataset.fid}-${card.dataset.pid}`;
            const count = counts[key] || 0;
            const badge = card.querySelector('.usage-counter');
            if (badge) {
                badge.innerText = count;
                badge.style.display = count > 0 ? 'block' : 'none';
            }
            card.style.borderColor = count > 0 ? '#28a745' : '#ddd';
        });
    }

    async function generatePDF() {
        const cards = newDocArea.querySelectorAll('.page-card');
        if (!cards.length) {
            alert("New document is empty!");
            return;
        }

        const selectedWidth = document.getElementById('target-width').value;
        const shouldScale = selectedWidth !== 'none';
        const targetWidthVal = parseFloat(selectedWidth);

        loader.style.display = 'flex';
        loaderText.innerText = 'Generating PDF...';

        try {
            const { PDFDocument, degrees } = PDFLib;
            const newPdf = await PDFDocument.create();
            const loadedPdfDocs = {};

            for (const card of cards) {
                const fid = card.dataset.fid;
                const dataItem = dataStore[fid];
                const userRotation = parseInt(card.dataset.rotation || 0);

                if (dataItem.type === 'pdf') {
                    const pid = parseInt(card.dataset.pid);
                    
                    if (!loadedPdfDocs[fid]) {
                        loadedPdfDocs[fid] = await PDFDocument.load(dataItem.buffer);
                    }
                    const srcDoc = loadedPdfDocs[fid];
                    const [copiedPage] = await newPdf.copyPages(srcDoc, [pid - 1]);

                    // 1. –°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–≤–æ—Ä–æ—Ç
                    copiedPage.setRotation(degrees(userRotation));

                    if (shouldScale) {
                        // 2. –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –£–ñ–ï —Å —É—á–µ—Ç–æ–º –ø–æ–≤–æ—Ä–æ—Ç–∞
                        const { width, height } = copiedPage.getSize();
                        
                        // 3. –°—á–∏—Ç–∞–µ–º –º–∞—Å—à—Ç–∞–± –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ç–µ–∫—É—â–µ–π (–ø–æ–≤–µ—Ä–Ω—É—Ç–æ–π) —à–∏—Ä–∏–Ω—ã
                        const scaleFactor = targetWidthVal / width;
                        
                        // 4. –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
                        copiedPage.scaleContent(scaleFactor, scaleFactor);
                        
                        // 5. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                        copiedPage.setSize(targetWidthVal, height * scaleFactor);
                    }
                    newPdf.addPage(copiedPage);

                } else {
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
                    let image;
                    if (dataItem.type === 'jpg') {
                        image = await newPdf.embedJpg(dataItem.buffer);
                    } else {
                        image = await newPdf.embedPng(dataItem.buffer);
                    }

                    const { width: imgW, height: imgH } = image;
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –ø–æ—Å–ª–µ –ø–æ–≤–æ—Ä–æ—Ç–∞
                    // –ï—Å–ª–∏ 90/270, —Ç–æ –≤–∏–∑—É–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ = –≤—ã—Å–æ—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏
                    const isRotated = userRotation === 90 || userRotation === 270;
                    const visualWidth = isRotated ? imgH : imgW;
                    const visualHeight = isRotated ? imgW : imgH;

                    let scale = 1;
                    if (shouldScale) {
                        scale = targetWidthVal / visualWidth;
                    }

                    // –†–∞–∑–º–µ—Ä—ã –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ (scaled)
                    const drawW = imgW * scale;
                    const drawH = imgH * scale;
                    
                    // –†–∞–∑–º–µ—Ä—ã —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–¥–æ–ª–∂–Ω—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –≤–∏–∑—É–∞–ª—å–Ω—ã–º —Ä–∞–∑–º–µ—Ä–∞–º)
                    const pageW = visualWidth * scale;
                    const pageH = visualHeight * scale;

                    const page = newPdf.addPage([pageW, pageH]);

                    // –í—ã—á–∏—Å–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ —Å —É—á–µ—Ç–æ–º –ø–æ–≤–æ—Ä–æ—Ç–∞
                    // pdf-lib –≤—Ä–∞—â–∞–µ—Ç –≤–æ–∫—Ä—É–≥ —Ç–æ—á–∫–∏ –ø—Ä–∏–≤—è–∑–∫–∏ (x,y), –ø–æ—ç—Ç–æ–º—É –Ω—É–∂–Ω–æ —Å–º–µ—â–∞—Ç—å –Ω–∞—á–∞–ª–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
                    let x = 0, y = 0;
                    if (userRotation === 0) { x = 0; y = 0; }
                    else if (userRotation === 90) { x = pageW; y = 0; }
                    else if (userRotation === 180) { x = pageW; y = pageH; }
                    else if (userRotation === 270) { x = 0; y = pageH; }

                    page.drawImage(image, {
                        x: x,
                        y: y,
                        width: drawW,
                        height: drawH,
                        rotate: degrees(userRotation)
                    });
                }
            }

            const pdfBytes = await newPdf.save();
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'merged_document.pdf';
            link.click();
        } catch (e) {
            console.error(e);
            alert("Error creating PDF: " + e.message);
        } finally {
            loader.style.display = 'none';
        }
    }
</script>

</body>
</html>