<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Page Builder - Final Fix</title>
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        :root {
            /* 
               Логика размеров:
               Рендерим картинку в качестве 1.5.
               Слева показываем её сжатой до ширины ~120px (визуально как scale 1.0).
               Справа показываем её шириной ~180px (визуально как scale 1.5).
            */
            --source-card-width: 130px; 
            --target-card-width: 200px; 
            
            --header-height: 60px;
            --toolbar-height: 50px;
            --primary-color: #007bff;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #f4f7f6;
            overflow: hidden;
        }

        /* Header */
        header {
            height: var(--header-height);
            background: #fff;
            padding: 0 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 20;
            flex-shrink: 0;
        }
        
        .header-actions { display: flex; gap: 10px; }
        
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
            font-weight: 500;
            font-size: 0.9rem;
        }
        .btn-primary { background: var(--primary-color); display: flex; align-items: center; }
        .btn-success { background: #28a745; }
        .btn:hover { opacity: 0.9; }
        input[type="file"] { display: none; }

        /* Toolbar */
        .toolbar {
            height: var(--toolbar-height);
            background: #e9ecef;
            display: flex;
            align-items: center;
            padding: 0 20px;
            border-bottom: 1px solid #ccc;
            gap: 20px;
            flex-shrink: 0;
        }
        .zoom-control { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }

        /* Workspace */
        .workspace {
            display: flex;
            height: calc(100vh - var(--header-height) - var(--toolbar-height));
            overflow: hidden; /* Важно для дочерних скроллов */
        }

        /* Left Panel (Sources) */
        .sources-panel {
            width: 450px;
            background: #f8f9fa;
            border-right: 1px solid #ccc;
            /* Исправление скролла: обычный блок с прокруткой */
            overflow-y: auto; 
            padding: 15px;
            flex-shrink: 0;
            height: 100%; 
            display: block;
        }

        .source-file {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .source-header {
            padding: 10px;
            background: #f1f1f1;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #eee;
        }

        .page-list {
            padding: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            background: #fff;
        }
        
        .source-file.collapsed .page-list { display: none; }

        /* Right Panel (Target) */
        .target-panel {
            flex: 1;
            padding: 20px;
            background: #fff;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: 100%;
        }

        .target-header { margin-bottom: 10px; font-weight: bold; color: #555; }

        #new-doc-area {
            flex: 1;
            border: 2px dashed #ccc;
            background: #fafafa;
            border-radius: 6px;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start;
            gap: 15px;
        }
        #new-doc-area.drag-over { background: #eef6ff; border-color: var(--primary-color); }

        /* CARD STYLES */
        .page-card {
            background: white;
            border: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: grab;
            position: relative;
            user-select: none;
            transition: width 0.1s ease;
        }

        /* Применение переменных ширины */
        .sources-panel .page-card { width: var(--source-card-width); }
        .target-panel .page-card { width: var(--target-card-width); }

        .page-card canvas {
            width: 100%;
            height: auto;
            pointer-events: none;
            display: block;
        }

        .page-number {
            width: 100%;
            text-align: center;
            font-size: 0.8rem;
            padding: 4px;
            background: #fff;
            color: #555;
            border-top: 1px solid #eee;
        }

        /* Кнопка удаления (только справа) */
        .remove-btn {
            position: absolute;
            top: -8px; right: -8px;
            width: 24px; height: 24px;
            background: #dc3545; color: white;
            border-radius: 50%;
            text-align: center; line-height: 22px;
            cursor: pointer; font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 10;
            display: none; 
        }
        #new-doc-area .page-card .remove-btn { display: block; }

        /* Счетчик (только слева) */
        .usage-counter {
            position: absolute;
            top: -8px; left: -8px;
            width: 24px; height: 24px;
            background: #28a745; color: white;
            border-radius: 50%;
            text-align: center; line-height: 24px;
            font-size: 12px; font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 10;
            display: none;
        }
        /* В правой панели счетчик не нужен */
        #new-doc-area .page-card .usage-counter { display: none !important; }

        /* Loader */
        .loading-overlay {
            position: fixed;
            top:0; left:0; right:0; bottom:0;
            background: rgba(255,255,255,0.9);
            z-index: 1000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid #f3f3f3; border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

<div class="loading-overlay" id="loader">
    <div class="spinner"></div>
    <div style="margin-top:10px">Processing...</div>
</div>

<header>
    <h1>PDF Page Builder</h1>
    <div class="header-actions">
        <label class="btn btn-primary">
            <span>+ Add PDF</span>
            <input type="file" id="file-input" multiple accept="application/pdf">
        </label>
        <button class="btn btn-success" onclick="generatePDF()">Download PDF</button>
    </div>
</header>

<div class="toolbar">
    <div class="zoom-control">
        <label>Source Zoom:</label>
        <!-- Диапазон увеличен -->
        <input type="range" id="source-zoom" min="80" max="400" value="130">
    </div>
    <div class="zoom-control">
        <label>Target Zoom:</label>
        <input type="range" id="target-zoom" min="100" max="500" value="200">
    </div>
</div>

<div class="workspace">
    <!-- Исходные файлы -->
    <div class="sources-panel" id="sources-container">
        <div style="text-align:center; color:#999; margin-top:20px;">
            Upload PDF files to start
        </div>
    </div>

    <!-- Новый документ -->
    <div class="target-panel">
        <div class="target-header">New Document</div>
        <div id="new-doc-area"></div>
    </div>
</div>

<script>
    // Настройка PDF.js
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    const fileInput = document.getElementById('file-input');
    const sourcesContainer = document.getElementById('sources-container');
    const newDocArea = document.getElementById('new-doc-area');
    const loader = document.getElementById('loader');

    const pdfDataStore = {}; 
    let fileCounter = 0;

    // --- Зум ---
    const sourceZoom = document.getElementById('source-zoom');
    const targetZoom = document.getElementById('target-zoom');
    const root = document.documentElement;

    sourceZoom.addEventListener('input', (e) => root.style.setProperty('--source-card-width', e.target.value + 'px'));
    targetZoom.addEventListener('input', (e) => root.style.setProperty('--target-card-width', e.target.value + 'px'));

    // --- Настройка Sortable (Target) ---
    new Sortable(newDocArea, {
        group: 'shared',
        animation: 150,
        ghostClass: 'sortable-ghost',
        
        onAdd: function (evt) {
            // Удаляем ID у копии, чтобы не мусорить DOM,
            // хотя для логики счетчиков это теперь не критично.
            evt.item.removeAttribute('id');
            updatePageCounters();
        },
        onSort: function (evt) {
            updatePageCounters();
        }
    });

    // Удаление страниц (делегирование)
    newDocArea.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-btn')) {
            e.target.closest('.page-card').remove();
            updatePageCounters();
        }
    });

    // --- Загрузка ---
    fileInput.addEventListener('change', async (e) => {
        const files = Array.from(e.target.files);
        if(!files.length) return;

        if(sourcesContainer.innerText.includes('Upload PDF')) sourcesContainer.innerHTML = '';
        loader.style.display = 'flex';
        
        for (const file of files) {
            try {
                await processFile(file);
            } catch (err) {
                console.error(err);
                alert("Error loading " + file.name);
            }
        }
        
        loader.style.display = 'none';
        fileInput.value = '';
    });

    async function processFile(file) {
        const fileId = `f${fileCounter++}`;
        const buffer = await file.arrayBuffer();
        pdfDataStore[fileId] = buffer.slice(0);

        const pdfDoc = await pdfjsLib.getDocument(buffer).promise;

        const fileDiv = document.createElement('div');
        fileDiv.className = 'source-file';
        
        const header = document.createElement('div');
        header.className = 'source-header';
        header.innerHTML = `<span>${file.name}</span><span>▼</span>`;
        header.onclick = () => fileDiv.classList.toggle('collapsed');

        const pageList = document.createElement('div');
        pageList.className = 'page-list';
        pageList.id = `list-${fileId}`;

        fileDiv.append(header, pageList);
        sourcesContainer.append(fileDiv);

        const renderScale = 1.0; 

        for (let i = 1; i <= pdfDoc.numPages; i++) {
            const page = await pdfDoc.getPage(i);
            const viewport = page.getViewport({ scale: renderScale });

            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = viewport.width;
            canvas.height = viewport.height;

            await page.render({ canvasContext: context, viewport: viewport }).promise;

            const card = document.createElement('div');
            card.className = 'page-card';
            
            // Записываем данные для идентификации
            card.dataset.fid = fileId;
            card.dataset.pid = i;

            card.innerHTML = `
                <div class="remove-btn">×</div>
                <div class="usage-counter">0</div>
                <div class="page-number">Page ${i}</div>
            `;
            // Вставляем канвас
            card.insertBefore(canvas, card.querySelector('.page-number'));
            pageList.appendChild(card);
        }

        // --- Sortable для исходников ---
        new Sortable(pageList, {
            group: {
                name: 'shared',
                pull: 'clone',
                put: false
            },
            sort: false,
            animation: 150,
            
            // КОПИРОВАНИЕ CANVAS
            onClone: function(evt) {
                const origCanvas = evt.item.querySelector('canvas');
                const cloneCanvas = evt.clone.querySelector('canvas');
                if (origCanvas && cloneCanvas) {
                    cloneCanvas.width = origCanvas.width;
                    cloneCanvas.height = origCanvas.height;
                    cloneCanvas.getContext('2d').drawImage(origCanvas, 0, 0);
                }
            }
        });
    }

    // --- Обновление счетчиков (Надежный метод) ---
    function updatePageCounters() {
        // 1. Собираем статистику из правой панели
        const targetCards = newDocArea.querySelectorAll('.page-card');
        const counts = {}; // "fileId-pageId" -> количество

        targetCards.forEach(card => {
            const key = `${card.dataset.fid}-${card.dataset.pid}`;
            counts[key] = (counts[key] || 0) + 1;
        });

        // 2. Проходим по всем карточкам в левой панели и обновляем их
        // Использование querySelectorAll внутри .sources-panel гарантирует, 
        // что мы находим визуально отображаемые элементы (клоны или оригиналы)
        const sourceCards = document.querySelectorAll('.sources-panel .page-card');
        
        sourceCards.forEach(card => {
            const key = `${card.dataset.fid}-${card.dataset.pid}`;
            const count = counts[key] || 0;
            
            const badge = card.querySelector('.usage-counter');
            if (badge) {
                badge.innerText = count;
                badge.style.display = count > 0 ? 'block' : 'none';
            }
            
            // Опционально: подсветка самой карточки
            if (count > 0) {
                card.style.borderColor = '#28a745';
            } else {
                card.style.borderColor = '#ddd';
            }
        });
    }

    // --- Генерация PDF ---
    async function generatePDF() {
        const cards = newDocArea.querySelectorAll('.page-card');
        if (!cards.length) {
            alert("New document is empty!");
            return;
        }

        loader.style.display = 'flex';
        try {
            const { PDFDocument } = PDFLib;
            const newPdf = await PDFDocument.create();
            const loadedDocs = {};

            for (const card of cards) {
                const fid = card.dataset.fid;
                const pid = parseInt(card.dataset.pid);

                if (!loadedDocs[fid]) {
                    loadedDocs[fid] = await PDFDocument.load(pdfDataStore[fid]);
                }
                
                // copyPages использует индекс 0-based, а у нас pid 1-based
                const [copiedPage] = await newPdf.copyPages(loadedDocs[fid], [pid - 1]);
                newPdf.addPage(copiedPage);
            }

            const pdfBytes = await newPdf.save();
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'merged.pdf';
            link.click();
        } catch (e) {
            console.error(e);
            alert("Error creating PDF");
        } finally {
            loader.style.display = 'none';
        }
    }
</script>

</body>
</html>